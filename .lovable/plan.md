

# Исправление триггера и подготовка к повторному переносу

## Проблемы

1. **Триггер `on_auth_user_created` не зарегистрирован** на таблице `auth.users`, хотя функция `handle_new_user` существует. При регистрации нового пользователя не создаются записи в `profiles`, `token_balances`, `ai_request_balances`, `settings`, `user_roles`, `wb_cabinets`.
2. **Данные `auth.users` не переносятся** через GitHub -- только код и миграции. Нужно заново регистрироваться.
3. **Токены и кнопка "Пополнить"** скрываются, когда баланс `null` (нет записи в `token_balances`).

## План

### 1. Пересоздать триггер в текущем проекте

Выполнить SQL-миграцию:

```sql
DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW
  EXECUTE FUNCTION public.handle_new_user();
```

Это гарантирует, что при регистрации в текущем и в перенесённом проекте триггер будет работать.

### 2. Добавить защиту в Header (опционально)

Сейчас если запись `token_balances` отсутствует, хук возвращает `0` (fallback в `useBalance`). Этого достаточно для отображения. Но если `user` равен `null`, хук отключен. Текущая логика корректна -- проблема именно в отсутствии триггера.

### 3. Инструкция для повторного переноса

При переносе через GitHub в новый проект:
- Миграции создадут все таблицы и функции, включая триггер
- **Зарегистрируйтесь заново** -- `auth.users` не переносится
- Триггер автоматически создаст `profiles`, `token_balances`, `settings`, `user_roles`, `wb_cabinets`
- Токены и кнопка "Пополнить" появятся в шапке
- **Секреты** (OPENROUTER_API_KEY и др.) нужно добавить вручную в новом проекте

## Технические детали

Единственное изменение -- одна SQL-миграция для пересоздания триггера. Файлы кода менять не нужно.

