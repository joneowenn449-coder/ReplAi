

# Система рекомендаций товаров в ответах на отзывы

## Концепция

Для каждого артикула можно вручную настроить список рекомендуемых артикулов. При генерации ответа на отзыв (ручной или авто) ИИ будет добавлять призыв посмотреть рекомендованные товары.

Пример: для артикула 471329594 настроены рекомендации 722695947, 722695948. В ответе на отзыв к этому артикулу ИИ добавит что-то вроде: "Также рекомендуем обратить внимание на наши другие модели: артикулы 722695947, 722695948".

## Изменения

### 1. Новая таблица `product_recommendations`

```text
product_recommendations
  id               uuid (PK, default gen_random_uuid())
  source_article   text NOT NULL   -- артикул, к которому привязаны рекомендации
  target_article   text NOT NULL   -- рекомендуемый артикул
  target_name      text            -- название рекомендуемого товара (для отображения)
  created_at       timestamptz     -- дата создания
  UNIQUE(source_article, target_article)
```

RLS-политики аналогичные остальным таблицам (authenticated: select, insert, delete; service role: all).

### 2. Новая секция в SettingsDialog -- "Рекомендации товаров"

Интерфейс управления:

- Выпадающий список (select) для выбора артикула-источника (из уникальных артикулов в reviews)
- Список уже добавленных рекомендаций для выбранного артикула с кнопкой удаления
- Поле ввода + кнопка "Добавить" для нового рекомендуемого артикула
- Название товара подтягивается автоматически из базы reviews (если есть)

### 3. Хуки для работы с рекомендациями

Новый файл `src/hooks/useRecommendations.ts`:

- `useProductArticles()` -- список уникальных артикулов из reviews
- `useRecommendations(sourceArticle)` -- рекомендации для конкретного артикула
- `useAddRecommendation()` -- мутация добавления
- `useDeleteRecommendation()` -- мутация удаления

### 4. Изменение `generate-reply` edge-функции

После загрузки отзыва -- дополнительный запрос в БД:
```
SELECT target_article, target_name FROM product_recommendations
WHERE source_article = review.product_article
```

Если рекомендации найдены, в userMessage добавляется инструкция:
```
В конце ответа добавь ненавязчивый призыв посмотреть наши другие товары:
артикулы 722695947 ("Сумка кросс-боди"), 722695948 ("Сумка кросс-боди").
```

### 5. Изменение `sync-reviews` edge-функции

Аналогичная логика: перед генерацией AI-ответа для каждого отзыва -- запрос рекомендаций по артикулу товара и передача их в prompt.

### 6. Изменение `send-reply` (не требуется)

Функция send-reply отправляет готовый текст, рекомендации уже будут включены в него на этапе генерации.

## Детали реализации

### Промпт для рекомендаций

Добавляется к userMessage (не к системному промпту), чтобы было контекстно привязано к конкретному отзыву:

```
РЕКОМЕНДАЦИИ: В конце ответа ненавязчиво предложи покупателю
обратить внимание на другие наши товары:
- Артикул 722695947: "Сумка кросс-боди через плечо маленькая"
- Артикул 722695948: "Сумка кросс-боди через плечо маленькая"
Упомяни артикулы, чтобы покупатель мог их найти на WB.
```

### UI в настройках

Секция будет расположена между "Режим ответов по рейтингу" и "Промпт для генерации". Интерфейс:

```text
+------------------------------------------+
| Рекомендации товаров                     |
|                                          |
| Артикул: [471329594 ▼]                   |
|                                          |
| Рекомендуемые товары:                    |
| ┌──────────────────────────────────────┐ |
| │ 722695947 - Сумка кросс-боди    [✕]  │ |
| │ 722695948 - Сумка кросс-боди    [✕]  │ |
| └──────────────────────────────────────┘ |
|                                          |
| [_введите артикул_] [+ Добавить]         |
+------------------------------------------+
```

## Файлы

| Файл | Действие |
|------|----------|
| Миграция БД (product_recommendations) | Создать таблицу + RLS |
| `src/hooks/useRecommendations.ts` | Новый файл -- хуки для CRUD |
| `src/components/SettingsDialog.tsx` | Добавить секцию рекомендаций |
| `supabase/functions/generate-reply/index.ts` | Подгрузка рекомендаций в промпт |
| `supabase/functions/sync-reviews/index.ts` | Подгрузка рекомендаций при автоответе |

## Результат

- В настройках можно указать, какие артикулы рекомендовать к каждому товару
- При генерации ответа (ручной и авто) ИИ добавляет призыв посмотреть рекомендованные артикулы
- Рекомендации хранятся в отдельной таблице, легко управляются через UI

