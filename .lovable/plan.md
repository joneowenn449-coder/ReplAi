

# Ввод и защита API-ключа в настройках

## Что будет сделано

В диалог настроек добавится секция для ввода API-ключа Wildberries. После ввода ключ будет проверен тестовым запросом к WB API. При успешном подключении ключ сохранится в базе данных, а в интерфейсе отобразится в замаскированном виде с защитой от случайного изменения или удаления.

## Как будет работать

1. Пользователь открывает настройки и видит поле "API-ключ Wildberries"
2. Вводит ключ и нажимает "Проверить подключение"
3. Система отправляет тестовый запрос к WB API
4. Если ключ валидный -- показывается зеленый статус "Подключено", ключ маскируется (например, `wb****...****k3`)
5. Для изменения ключа нужно нажать кнопку "Изменить", а затем подтвердить действие
6. Кнопка удаления ключа требует отдельного подтверждения через диалог

## Шаги реализации

### 1. Миграция базы данных

Добавить колонку `wb_api_key` в таблицу `settings`:

```text
ALTER TABLE settings ADD COLUMN wb_api_key text;
```

### 2. Новая backend-функция `validate-api-key`

Создать edge-функцию, которая:
- Принимает API-ключ в теле запроса
- Делает тестовый GET-запрос к `https://feedbacks-api.wildberries.ru/api/v1/feedbacks?isAnswered=false&take=1`
- Если ответ 200 -- ключ валидный, сохраняет его в таблицу `settings`
- Возвращает результат проверки (успех/ошибка)

### 3. Обновить edge-функции для чтения ключа из БД

Функции `sync-reviews` и `send-reply` будут сначала читать `wb_api_key` из таблицы `settings`. Если в таблице ключ не найден, используется fallback на переменную окружения `WB_API_KEY` (для обратной совместимости).

### 4. Обновить интерфейс настроек (SettingsDialog)

Добавить в диалог настроек секцию с API-ключом:

- **Состояние "нет ключа"**: Поле ввода + кнопка "Проверить подключение"
- **Состояние "ключ сохранен"**: Замаскированный ключ + зеленый индикатор "Подключено" + кнопка "Изменить" (иконка карандаша)
- **Режим редактирования**: Поле ввода с текущим замаскированным значением + кнопки "Проверить" и "Отмена"
- **Защита от удаления**: При нажатии "Удалить ключ" -- всплывающее подтверждение "Вы уверены? Синхронизация перестанет работать"

### 5. Обновить компонент ApiStatus

Статус подключения (`isConnected`) будет определяться наличием сохраненного API-ключа в настройках, а не быть захардкоженным `true`.

### 6. Обновить хуки

- Добавить `wb_api_key` в интерфейс `Settings`
- Добавить хук `useValidateApiKey` для вызова edge-функции проверки
- Добавить хук `useDeleteApiKey` для удаления ключа (обнуление поля в settings)

## Технические детали

**Безопасность ключа в БД:**
- Ключ хранится в таблице `settings`, доступ к которой контролируется RLS-политиками
- На фронтенде ключ маскируется: показываются только первые 4 и последние 4 символа
- Edge-функции читают полный ключ на сервере через service_role

**Защита от случайных действий:**
- Поле ввода заблокировано после сохранения (нужно явно нажать "Изменить")
- Удаление требует подтверждения через AlertDialog
- При вводе нового ключа обязательна проверка (нельзя сохранить без валидации)

**Файлы, которые будут изменены:**
- Миграция БД (новая колонка `wb_api_key`)
- `supabase/functions/validate-api-key/index.ts` -- новая функция
- `supabase/functions/sync-reviews/index.ts` -- чтение ключа из БД
- `supabase/functions/send-reply/index.ts` -- чтение ключа из БД
- `src/components/SettingsDialog.tsx` -- секция API-ключа
- `src/hooks/useReviews.ts` -- новые хуки
- `src/pages/Index.tsx` -- передача статуса подключения
- `src/components/ApiStatus.tsx` -- динамический статус
- `supabase/config.toml` -- регистрация новой функции

