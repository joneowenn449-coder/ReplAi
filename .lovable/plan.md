
# Учёт фото/видео контента в ответах ИИ

## Проблема

Сейчас при генерации ответа на отзыв ИИ не знает, что покупатель приложил фотографии или видео. Из-за этого ИИ не благодарит за визуальный контент и не упоминает его в ответе.

## Что нужно сделать

Передавать информацию о наличии фото/видео в промпт для ИИ, чтобы модель учитывала это при генерации ответа.

## Изменения

### 1. Добавить хранение видео в БД

Wildberries API возвращает поле `video` (объект с `previewImage`, `link`, `durationSec`). Сейчас мы его не сохраняем.

**Миграция**: добавить колонку `has_video` (boolean, default false) в таблицу `reviews`. Это проще и надёжнее, чем хранить полный объект видео -- нам нужно только знать, есть ли видео.

### 2. Обновить `supabase/functions/sync-reviews/index.ts`

- При сохранении нового отзыва: проверять `fb.video` и записывать `has_video: true/false`.
- В функции `generateAIReply`: добавить параметры `photoCount` и `hasVideo`.
- Дополнить `userMessage` строкой вида:
  - "К отзыву приложено 3 фотографии." (если есть фото)
  - "К отзыву приложено видео." (если есть видео)
  - "К отзыву приложено 3 фотографии и видео." (если есть и то, и другое)

### 3. Обновить `supabase/functions/generate-reply/index.ts`

При построении `userMessage` -- считать количество элементов в `review.photo_links` и проверять `review.has_video`, добавлять соответствующую информацию в промпт перед отправкой в OpenRouter.

### 4. Обновить `supabase/functions/fetch-archive/index.ts`

При загрузке архивных отзывов: также сохранять `has_video` из данных WB API.

### 5. Обновить `src/hooks/useReviews.ts`

Добавить поле `has_video: boolean` в интерфейс `Review`.

## Технические детали

### Миграция БД

```sql
ALTER TABLE reviews ADD COLUMN has_video boolean NOT NULL DEFAULT false;
```

### Формат дополнения к промпту

В `userMessage` перед текстом отзыва или после него добавляется блок:

```text
Отзыв (5 из 5 звёзд) на товар "Название":

Текст отзыва...

[Покупатель приложил 3 фотографии и видео к отзыву.]
```

Это позволит ИИ естественно упомянуть визуальный контент и поблагодарить покупателя за подробный отзыв с фото/видео.

### Файлы для изменения

- `src/hooks/useReviews.ts` -- добавить `has_video` в интерфейс
- `supabase/functions/sync-reviews/index.ts` -- передавать фото/видео в промпт, сохранять `has_video`
- `supabase/functions/generate-reply/index.ts` -- передавать фото/видео в промпт
- `supabase/functions/fetch-archive/index.ts` -- сохранять `has_video`
