
# Режим обучения ИИ в админ-панели

## Обзор

Добавляем новую вкладку **"Обучение ИИ"** в админ-панели (/admin), где администратор сможет управлять тремя инструментами, которые напрямую влияют на качество генерируемых ответов для **всех** пользователей.

---

## Что получим

- **Эталонные ответы** -- библиотека пар "отзыв - идеальный ответ", которые подставляются в промпт как примеры. ИИ начнёт точнее копировать желаемый стиль.
- **Правила и запреты** -- структурированный чеклист инструкций ("всегда упоминай гарантию", "не предлагай скидку"). Нагляднее и управляемее, чем текст в промпте.
- **Обратная связь** -- кнопки "хорошо"/"плохо" на сгенерированных ответах. Накопленная статистика покажет качество и поможет корректировать поведение ИИ.

---

## Структура реализации

### 1. Новые таблицы в базе данных

**ai_example_responses** -- эталонные пары:
- id, review_rating (1-5), review_text, ideal_response, category (по типу отзыва), is_active, created_by (admin), created_at

**ai_rules** -- правила и запреты:
- id, rule_text, rule_type ("do" или "dont"), priority (порядок), is_active, created_by, created_at

**ai_feedback** -- обратная связь:
- id, review_id (ссылка на отзыв), ai_draft (текст ответа), feedback ("good"/"bad"), comment (опциональный комментарий), user_id, created_at

RLS-политики: чтение для авторизованных пользователей, запись только для админов (для examples и rules), запись от пользователя (для feedback).

### 2. Новая вкладка в админке

Файл: `src/components/admin/AiTraining.tsx`

Три секции внутри вкладки:

**Эталонные ответы:**
- Таблица с примерами: рейтинг, текст отзыва (сокращённый), ответ, категория, переключатель активности
- Кнопка "Добавить пример" -- форма с полями: рейтинг, текст отзыва, идеальный ответ, категория
- Удаление и редактирование существующих

**Правила и запреты:**
- Два списка: "Делать" (зелёные) и "Не делать" (красные)
- Добавление/удаление правил, drag-and-drop для приоритета
- Переключатель активности для каждого правила

**Статистика обратной связи:**
- Общее количество лайков/дизлайков
- Процент положительных оценок
- Список последних "плохих" ответов с комментариями для анализа

### 3. Интеграция в generate-reply

Обновление edge-функции `generate-reply`:
- При генерации ответа: загружать активные правила из `ai_rules` и добавлять в системный промпт
- Загружать 2-3 эталонных примера из `ai_example_responses` (по рейтингу отзыва) и вставлять как few-shot examples
- Правила форматируются в блок "ОБЯЗАТЕЛЬНЫЕ ПРАВИЛА" и "ЗАПРЕЩЕНО" в промпте

### 4. Кнопки обратной связи в интерфейсе пользователя

В компоненте `ReviewCard.tsx`:
- После генерации ai_draft: показать маленькие кнопки "хорошо" / "плохо"
- При нажатии "плохо" -- опциональное поле для комментария
- Данные сохраняются в таблицу `ai_feedback`

### 5. Обновление страницы Admin.tsx

- Новая вкладка "Обучение ИИ" с иконкой BrainCircuit
- Хук `useAiTraining.ts` для CRUD-операций с примерами, правилами и статистикой

---

## Технические детали

### Файлы для создания:
- `src/components/admin/AiTraining.tsx` -- основной компонент вкладки
- `src/components/admin/ExampleResponses.tsx` -- управление эталонными ответами
- `src/components/admin/AiRules.tsx` -- управление правилами
- `src/components/admin/AiFeedbackStats.tsx` -- статистика обратной связи
- `src/hooks/useAiTraining.ts` -- хуки для работы с данными обучения

### Файлы для изменения:
- `src/pages/Admin.tsx` -- добавление вкладки
- `supabase/functions/generate-reply/index.ts` -- интеграция правил и примеров в промпт
- `src/components/ReviewCard.tsx` -- кнопки обратной связи

### Формат промпта с обучением:

```text
[Основной промпт из "Вайб компании"]

ОБЯЗАТЕЛЬНЫЕ ПРАВИЛА:
1. Всегда упоминай гарантию
2. Обращайся по имени

ЗАПРЕЩЕНО:
1. Не предлагай скидки
2. Не используй слово "извините"

ПРИМЕРЫ ИДЕАЛЬНЫХ ОТВЕТОВ:
---
Отзыв (4/5): "Хорошая куртка, но пуговица отвалилась"
Ответ: "Мария, благодарим за отзыв! ..."
---
```

Миграция: 3 новые таблицы + RLS-политики. Обратная совместимость полная -- если таблицы пустые, generate-reply работает как раньше.
