

# Индикация новых сообщений в чатах

## Проблемы

1. **Таблица `chats` не подключена к Realtime** -- подписка в коде есть, но таблица не добавлена в публикацию `supabase_realtime`. Поэтому при обновлении статуса `is_read` через `sync-chats` интерфейс не получает уведомление.
2. **Нет бейджа на вкладке "Чаты"** -- когда пользователь на вкладке "Отзывы", он не видит, что пришли новые сообщения.
3. **Нет резервного механизма** -- если Realtime-соединение оборвётся, интерфейс перестанет обновляться.

## Решение

### 1. Добавить таблицу `chats` в Realtime-публикацию

**SQL миграция:**

```sql
ALTER PUBLICATION supabase_realtime ADD TABLE public.chats;
```

Без этого подписка в `useChats` не получает событий, несмотря на то что код подписки уже написан.

### 2. Добавить бейдж непрочитанных на вкладку "Чаты"

**Файл: `src/components/NavTabs.tsx`**

Добавить проп `unreadChatsCount` и отображать красный бейдж с числом рядом с текстом "Чаты":

```text
Чаты [3]   <-- красный кружок с числом непрочитанных
```

Бейдж показывается только если `unreadChatsCount > 0`.

### 3. Передать счётчик из родительского компонента

**Файл: `src/pages/Index.tsx`**

Подключить `useChats` и посчитать количество чатов с `is_read === false`. Передать это число в `NavTabs` как проп.

### 4. Добавить polling-fallback в useChats

**Файл: `src/hooks/useChats.ts`**

Добавить `refetchInterval` к запросу чатов -- каждые 30 секунд перезапрашивать список чатов. Это гарантирует обновление даже при потере Realtime-соединения:

```text
useQuery({
  queryKey: ["chats"],
  queryFn: ...,
  refetchInterval: 30_000,  // fallback: каждые 30 сек
})
```

## Файлы

| Файл | Изменение |
|------|-----------|
| SQL миграция | Добавить `chats` в `supabase_realtime` |
| `src/hooks/useChats.ts` | Добавить `refetchInterval: 30000` для polling-fallback |
| `src/components/NavTabs.tsx` | Добавить проп `unreadChatsCount` и бейдж |
| `src/pages/Index.tsx` | Подсчёт непрочитанных чатов и передача в NavTabs |

## Результат

- Realtime начнёт работать для таблицы `chats` -- мгновенное обновление при новых сообщениях
- Красный бейдж на вкладке "Чаты" покажет количество непрочитанных чатов
- Polling каждые 30 секунд гарантирует обновление даже при сбое Realtime

