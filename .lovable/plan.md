
# Автоматическое определение бренда из WB API

## Ситуация

У одного продавца на WB может быть несколько брендов под одним API-ключом. WB API уже возвращает поле `productDetails.brandName` в каждом отзыве -- то есть бренд известен автоматически, без ручной привязки.

## Решение

Сохранять название бренда из WB API прямо в отзыв и использовать его при генерации ответа. Дополнительно -- поле "бренд по умолчанию" в настройках как запасной вариант.

## Что будет сделано

### 1. Добавить колонку `brand_name` в таблицу отзывов

Каждый отзыв будет хранить название бренда, полученное от WB API. Это покроет мультибрендовые магазины автоматически.

### 2. Добавить поле `brand_name` в настройки

Запасной вариант: если WB API не вернул бренд (редкий случай), используется значение из настроек. Для текущего аккаунта -- установить "LUNERA".

### 3. Сохранять бренд при синхронизации

При получении отзывов из WB -- извлекать `productDetails.brandName` и записывать в колонку `brand_name` отзыва.

### 4. Использовать бренд при генерации ответа

При формировании сообщения для ИИ -- добавлять строку:
```
Название бренда продавца: {brand_name}. Используй его при ответе.
```
Приоритет: бренд из отзыва, затем бренд из настроек.

### 5. Убрать упоминание LUNERA из системного промпта

Промпт станет полностью универсальным.

### 6. Добавить поле "Название бренда" в настройки (UI)

Новое текстовое поле в диалоге настроек -- "Название бренда (по умолчанию)".

## Технические детали

### SQL-миграция

```sql
-- Колонка бренда в отзывах (из WB API)
ALTER TABLE public.reviews
ADD COLUMN brand_name text NOT NULL DEFAULT '';

-- Поле бренда по умолчанию в настройках
ALTER TABLE public.settings
ADD COLUMN brand_name text NOT NULL DEFAULT '';

-- Установить бренд для текущего аккаунта
UPDATE public.settings
SET brand_name = 'LUNÉRA'
WHERE user_id = '5339ed4d-37c9-4fc1-bed9-dc4604bdffe6';

-- Убрать хардкод LUNÉRA из промпта
UPDATE public.settings
SET ai_prompt_template = (обновленный универсальный промпт без упоминания бренда)
WHERE user_id = '5339ed4d-37c9-4fc1-bed9-dc4604bdffe6';
```

### Изменяемые файлы

1. **`supabase/functions/sync-reviews/index.ts`**
   - Извлекать `fb.productDetails?.brandName` при синхронизации
   - Сохранять в колонку `brand_name` отзыва
   - Загружать `brand_name` из settings
   - Передавать бренд в `generateAIReply`
   - Добавлять инструкцию с брендом в user-сообщение

2. **`supabase/functions/generate-reply/index.ts`**
   - Загружать `brand_name` из settings вместе с промптом
   - Загружать `brand_name` из самого отзыва
   - Приоритет: review.brand_name -> settings.brand_name
   - Добавлять инструкцию с брендом в user-сообщение

3. **`src/components/SettingsDialog.tsx`**
   - Новое текстовое поле "Название бренда (по умолчанию)"
   - Подсказка: "Используется, если бренд не определен автоматически из WB"
   - Сохраняется вместе с промптом

4. **`src/hooks/useReviews.ts`**
   - Добавить `brand_name` в интерфейс `Settings`

### Логика определения бренда в edge-функциях

```text
Приоритет:
1. review.brand_name (из WB API, привязан к конкретному отзыву)
2. settings.brand_name (по умолчанию, задан пользователем)
3. Не добавлять инструкцию (если оба пустые)
```

### Пример добавляемой инструкции

Если бренд определён (например, "LUNERA"):
```
Название бренда продавца: LUNÉRA. Используй это название при обращении к покупателю.
```

Если бренд не определён -- строка не добавляется, промпт работает без привязки к бренду.
