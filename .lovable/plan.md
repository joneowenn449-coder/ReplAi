

# Монетизация ReplAi -- полный план

Это масштабная задача, которую нужно реализовывать поэтапно. Ниже описана полная архитектура и порядок реализации.

---

## Текущее состояние

Сейчас приложение работает без авторизации: один экземпляр, одна таблица `settings`, все данные доступны всем. Для монетизации нужно добавить:
- Систему пользователей
- Привязку данных к конкретному пользователю
- Баланс токенов
- Подписки на AI аналитик
- Админ-панель
- Интеграцию с платёжной системой

---

## Фаза 1: Аутентификация и мультитенантность

### Что делаем
Добавляем регистрацию/вход по номеру телефона и привязываем все данные к конкретному пользователю.

### Новые таблицы

**profiles** -- профиль пользователя
- `id` (uuid, PK, ссылка на auth.users)
- `phone` (text)
- `display_name` (text)
- `created_at` (timestamp)

**user_roles** -- роли (admin/user)
- `id` (uuid, PK)
- `user_id` (uuid, FK -> auth.users)
- `role` (enum: admin, user)

### Изменения существующих таблиц
- `settings` -- добавить `user_id` (uuid, FK -> auth.users)
- `reviews` -- добавить `user_id` (uuid, FK -> auth.users)
- `chats` -- добавить `user_id` (uuid, FK -> auth.users)
- `chat_messages` -- добавить `user_id` (uuid, FK -> auth.users)
- `product_recommendations` -- добавить `user_id` (uuid, FK -> auth.users)

### RLS-политики
Все политики обновятся: пользователь видит только свои данные (`user_id = auth.uid()`). Админ видит все данные через функцию `has_role()`.

### Страницы
- `/auth` -- вход/регистрация по телефону
- Редирект неавторизованных на `/auth`
- Автосоздание профиля при регистрации через триггер

### Стартовые токены
При регистрации автоматически начисляются бесплатные стартовые токены (количество настраивается).

---

## Фаза 2: Система токенов

### Новые таблицы

**token_balances** -- баланс токенов пользователя
- `id` (uuid, PK)
- `user_id` (uuid, FK -> auth.users, unique)
- `balance` (integer, default 0)
- `updated_at` (timestamp)

**token_transactions** -- история всех операций с токенами
- `id` (uuid, PK)
- `user_id` (uuid, FK -> auth.users)
- `amount` (integer) -- положительное = пополнение, отрицательное = списание
- `type` (enum: purchase, spend, bonus, refund, admin_adjust)
- `description` (text) -- например "Ответ на отзыв #123"
- `review_id` (uuid, nullable, FK -> reviews)
- `created_at` (timestamp)

### Логика списания
При отправке ответа на отзыв (edge function `send-reply`):
1. Проверить баланс пользователя
2. Если баланс > 0 -- списать 1 токен и отправить ответ
3. Если баланс = 0 -- вернуть ошибку "Недостаточно токенов"
4. Записать транзакцию в `token_transactions`

### UI-изменения
- Отображение баланса токенов в шапке
- Предупреждение при низком балансе
- Блокировка кнопки "Отправить" при нулевом балансе
- Страница истории транзакций

---

## Фаза 3: Подписки на AI аналитик

### Новые таблицы

**subscriptions** -- подписки пользователей
- `id` (uuid, PK)
- `user_id` (uuid, FK -> auth.users)
- `plan` (text) -- название плана
- `status` (enum: active, expired, cancelled)
- `starts_at` (timestamp)
- `expires_at` (timestamp)
- `created_at` (timestamp)

**subscription_plans** -- доступные планы (управляются админом)
- `id` (uuid, PK)
- `name` (text) -- например "Месячный", "Годовой"
- `duration_days` (integer) -- 30, 90, 365
- `price` (numeric)
- `is_active` (boolean)
- `created_at` (timestamp)

### Логика доступа
- Вкладка "AI аналитик" доступна только при активной подписке
- При отсутствии подписки -- показываем экран с предложением оформить подписку
- Edge function `ai-assistant` проверяет наличие активной подписки перед ответом

---

## Фаза 4: Админ-панель

### Маршрут `/admin`
Доступен только пользователям с ролью `admin`. Включает:

**Дашборд**
- Общее количество пользователей
- Активные пользователи за период
- Общая выручка
- Графики регистраций и покупок

**Управление пользователями**
- Список всех пользователей с поиском
- Информация: телефон, дата регистрации, баланс токенов, статус подписки
- Возможность начислить/списать токены вручную
- Активировать/деактивировать подписку

**Управление тарифами**
- Настройка цены токена
- Настройка планов подписки (название, срок, цена)
- Количество стартовых токенов для новых пользователей

**История транзакций**
- Все покупки токенов и подписок
- Фильтры по пользователю, типу, дате

---

## Фаза 5: Интеграция с ЮKassa

### Что нужно
- Аккаунт в ЮKassa (https://yookassa.ru)
- Shop ID и секретный ключ

### Edge Functions
- `create-payment` -- создание платежа через API ЮKassa
- `payment-webhook` -- приём уведомлений об успешной оплате

### Процесс покупки токенов
1. Пользователь выбирает пакет токенов на странице "Пополнить баланс"
2. Фронтенд вызывает `create-payment` с суммой и типом
3. Edge function создаёт платёж в ЮKassa и возвращает URL для оплаты
4. Пользователь переходит на страницу оплаты ЮKassa
5. После оплаты ЮKassa отправляет webhook на `payment-webhook`
6. Edge function проверяет подпись, начисляет токены, записывает транзакцию
7. Пользователь возвращается в приложение и видит обновлённый баланс

Аналогичный процесс для покупки подписки на AI аналитик.

---

## Порядок реализации

Рекомендую начинать с Фазы 1 (аутентификация), потому что все остальные фазы зависят от неё. Каждую фазу можно реализовывать и тестировать отдельно.

```text
Фаза 1: Аутентификация       [базовая, нужна первой]
    |
    v
Фаза 2: Токены               [можно начислять вручную через админку]
    |
    v
Фаза 3: Подписки AI          [аналогично, вручную через админку]
    |
    v
Фаза 4: Админ-панель         [управление пользователями и балансами]
    |
    v
Фаза 5: ЮKassa               [автоматизация оплаты]
```

---

## Важные замечания

- **Авторизация по телефону** требует подключения SMS-провайдера (Twilio, MessageBird или другого). Это платная услуга -- каждая SMS стоит денег. Альтернатива -- вход по email + пароль (бесплатно) или через Google/Apple.
- **ЮKassa** потребует отдельной настройки: Shop ID и секретный ключ будут храниться как секреты в бэкенде.
- **Миграция существующих данных**: при добавлении `user_id` в существующие таблицы нужно будет привязать текущие записи к вашему admin-аккаунту.

---

## С чего начать?

Предлагаю начать с **Фазы 1** -- добавить аутентификацию. После одобрения я создам:
1. Таблицы `profiles` и `user_roles`
2. Страницу входа/регистрации
3. Добавлю `user_id` во все существующие таблицы
4. Обновлю RLS-политики
5. Настрою автосоздание профиля при регистрации

