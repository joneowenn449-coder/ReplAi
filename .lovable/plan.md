
# Исправление сброса статуса прочтения чатов при синхронизации

## Проблема

При каждой синхронизации (каждые 5 минут) функция `sync-chats` перезаписывает поле `sent_at` у всех сообщений текущим временем, потому что WB API возвращает дату в поле, которое код не распознаёт. Затем функция сравнивает обновлённое `sent_at` с сохранённым `last_message_at`, считает сообщения "новыми" и сбрасывает `is_read` в `false` -- даже для уже прочитанных чатов.

## Решение (два исправления в одном файле)

### Файл: `supabase/functions/sync-chats/index.ts`

**Исправление 1: Не перезаписывать существующие сообщения**

В Step 3 (строка ~177) при upsert сообщений добавить `ignoreDuplicates: true`. Это означает: вставить новое сообщение если его нет, но если `event_id` уже существует -- ничего не делать. Так `sent_at` не будет перезаписываться при каждой синхронизации.

- Было: `{ onConflict: "event_id" }`
- Станет: `{ onConflict: "event_id", ignoreDuplicates: true }`

Также нужно скорректировать подсчёт `newMessages`: с `ignoreDuplicates` upsert не возвращает ошибку для пропущенных дубликатов, поэтому считать нужно по фактически вставленным строкам (через `count` или `data`).

**Исправление 2: Отслеживать реально новые сообщения**

В Step 4 (строки 207-242) вместо сравнения временных меток, использовать множество `chatsWithNewMessages` (Set), куда добавляются chat_id только тех чатов, для которых в Step 3 были реально вставлены новые сообщения от покупателей (sender = "client"). Только для этих чатов устанавливать `is_read = false`.

Логика:
1. В Step 3 при вставке сообщения: если upsert вернул данные (строка вставлена) и `sender === "client"` -- добавить `chatId` в `chatsWithNewMessages`
2. В Step 4 убрать сравнение по `isNewClientMessage` с временными метками. Вместо этого: если `chat.chat_id` есть в `chatsWithNewMessages`, тогда `is_read = false`

### Результат

- Прочитанные чаты остаются прочитанными между синхронизациями
- `is_read` сбрасывается в `false` только при получении действительно нового сообщения от покупателя
- Хронология сообщений (`sent_at`) сохраняется корректно и не перезаписывается при каждой синхронизации
