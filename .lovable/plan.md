

# Подготовка инфраструктуры Робокассы (без ключей)

## Подход

Создаём полную инфраструктуру оплаты, которая будет работать сразу после ввода ключей. До этого момента кнопка "Пополнить" будет показывать сообщение, что оплата пока недоступна (или откроет страницу выбора тарифа, но без возможности оплатить).

## Что будет создано

### 1. Таблица `payments` в базе данных

Хранит информацию о каждом платеже:
- `id` (UUID, первичный ключ)
- `inv_id` (SERIAL, числовой ID для протокола Робокассы)
- `user_id` (UUID, ссылка на пользователя)
- `amount` (numeric, сумма в рублях)
- `tokens` (integer, количество токенов к зачислению)
- `status` (text: pending / completed / failed)
- `created_at`, `updated_at`

RLS-политики: пользователь видит только свои платежи.

### 2. Edge-функция `create-payment`

Формирует подписанную ссылку на оплату Робокассы:
- Принимает сумму и количество токенов
- Создаёт запись в `payments` со статусом `pending`
- Генерирует MD5-подпись: `MerchantLogin:OutSum:InvId:Password1`
- Возвращает URL для редиректа на Робокассу
- **Без ключей**: вернёт ошибку с понятным сообщением "Оплата пока не настроена"

### 3. Edge-функция `robokassa-webhook`

Принимает POST от Робокассы после успешной оплаты:
- Проверяет подпись: `OutSum:InvId:Password2`
- Обновляет статус платежа на `completed`
- Зачисляет токены на баланс пользователя
- Возвращает `OK{InvId}` (требование протокола)

### 4. Страница выбора тарифа (`/pricing`)

Простая страница с тарифными планами:
- Несколько вариантов пакетов токенов (например: 50, 200, 500 токенов)
- Кнопка "Оплатить" вызывает `create-payment`
- Редирект на Робокассу для оплаты

### 5. Страница возврата (`/payment/return`)

После оплаты Робокасса перенаправляет пользователя сюда:
- Проверяет статус платежа
- Показывает "Оплата прошла успешно" или "Ожидаем подтверждения"

### 6. Обновление кнопки "Пополнить" в Header

Вместо toast-заглушки — переход на страницу `/pricing`.

## Секреты (добавить позже)

Когда сайт будет опубликован и Робокасса выдаст данные, нужно будет добавить 3 секрета:
- `ROBOKASSA_LOGIN` — логин магазина
- `ROBOKASSA_PASSWORD1` — пароль для формирования ссылки
- `ROBOKASSA_PASSWORD2` — пароль для проверки вебхука

До добавления этих секретов функции будут корректно обрабатывать отсутствие ключей и сообщать пользователю.

## Порядок реализации

1. Миграция БД: таблица `payments`
2. Edge-функция `create-payment`
3. Edge-функция `robokassa-webhook`
4. Страница `/pricing` с тарифами
5. Страница `/payment/return`
6. Обновление Header (кнопка "Пополнить")
7. Обновление маршрутов в `App.tsx`

## Технические детали

- Протокол Робокассы: MD5-подпись, числовой `inv_id`, ответ `OK{InvId}`
- Edge-функции проверяют наличие секретов и gracefully деградируют
- Тестовый режим Робокассы (`isTest=1`) будет включен по умолчанию — переключить на боевой после отладки
- Тарифы можно будет легко менять в коде страницы `/pricing`
