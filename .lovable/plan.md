

# Реализация обучения ИИ — Dynamic Few-Shot Prompting

## Подход
Используем Dynamic Few-Shot Prompting: правила и эталонные примеры хранятся в обычных таблицах и подставляются в системный промпт при генерации ответа. Без векторных эмбеддингов, быстро и эффективно.

---

## Шаг 1. Миграция базы данных

Создаём 3 таблицы:

**ai_example_responses** — эталонные пары "отзыв + идеальный ответ":
- review_rating (1-5), review_text, ideal_response, category, is_active, created_by

**ai_rules** — правила и запреты:
- rule_text, rule_type ("do" / "dont"), priority, is_active, created_by

**ai_feedback** — обратная связь от пользователей:
- review_id, ai_draft, feedback ("good"/"bad"), comment, user_id

RLS: админы управляют примерами и правилами; пользователи могут оставлять feedback на свои отзывы.

---

## Шаг 2. Хук useAiTraining.ts

CRUD-операции для всех трёх таблиц:
- Загрузка/создание/удаление/обновление примеров и правил
- Загрузка статистики feedback (количество good/bad, процент, последние плохие)

---

## Шаг 3. Компоненты админки

**AiTraining.tsx** — контейнер с тремя секциями (Tabs):

**ExampleResponses.tsx:**
- Таблица с примерами (рейтинг, текст, ответ, категория, вкл/выкл)
- Диалог добавления/редактирования примера

**AiRules.tsx:**
- Два списка: "Делать" и "Не делать"
- Добавление/удаление правил, переключатель активности

**AiFeedbackStats.tsx:**
- Карточки со статистикой (всего, хороших, плохих, процент)
- Список последних негативных оценок с комментариями

---

## Шаг 4. Обновление Admin.tsx

Новая вкладка "Обучение ИИ" с иконкой BrainCircuit.

---

## Шаг 5. Интеграция в generate-reply

Обновление edge-функции:
- Загрузка активных правил из ai_rules
- Загрузка 2-3 примеров из ai_example_responses по рейтингу отзыва
- Форматирование в блоки "ОБЯЗАТЕЛЬНЫЕ ПРАВИЛА", "ЗАПРЕЩЕНО", "ПРИМЕРЫ ИДЕАЛЬНЫХ ОТВЕТОВ" и добавление в системный промпт
- Если таблицы пустые — работает как раньше (обратная совместимость)

---

## Шаг 6. Кнопки обратной связи в ReviewCard.tsx

- После генерации ai_draft: кнопки "хорошо" / "плохо"
- При "плохо" — поле для комментария
- Сохранение в ai_feedback

---

## Порядок реализации

1. Миграция БД (3 таблицы + RLS)
2. useAiTraining.ts
3. Компоненты админки (ExampleResponses, AiRules, AiFeedbackStats, AiTraining)
4. Admin.tsx — новая вкладка
5. generate-reply — интеграция в промпт
6. ReviewCard.tsx — кнопки feedback

