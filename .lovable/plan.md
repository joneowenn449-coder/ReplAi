

# AI Ассистент -- умный помощник по товарам и отзывам

## Концепция

Окно чата с ИИ, который имеет полный доступ к базе данных отзывов. При каждом вопросе пользователя edge-функция подгружает релевантные данные из БД (по артикулу, товару, ключевым словам) и передаёт их в контекст ИИ. Ассистент отвечает на вопросы вроде:

- "Какие основные жалобы на артикул 471329594?"
- "Что покупатели хвалят в сумке кросс-боди?"
- "Сколько отзывов с оценкой ниже 3?"
- "Покажи статистику по всем товарам"

## Архитектура

```text
Пользователь вводит вопрос
        |
        v
Frontend (ChatPanel) --> Edge Function (ai-assistant)
                                |
                                v
                         1. Поиск релевантных отзывов в БД
                            - по артикулу (если упомянут)
                            - по названию товара
                            - по ключевым словам
                            - агрегированная статистика
                                |
                                v
                         2. Формирование системного промпта
                            с контекстом из БД
                                |
                                v
                         3. Запрос к Lovable AI (streaming)
                                |
                                v
                         4. SSE-поток обратно на фронтенд
```

## Файлы и изменения

### 1. Новый файл: `supabase/functions/ai-assistant/index.ts`

Edge-функция, которая:

- Принимает `messages` (историю диалога) от фронтенда
- Извлекает из последнего сообщения упоминания артикулов (regex на числа 6+ цифр), названий товаров
- Делает запросы в БД:
  - Общая статистика: количество отзывов, средний рейтинг по каждому артикулу
  - Если найден артикул -- подгружает до 50 последних отзывов с текстом, pros, cons, rating
  - Если нет конкретного артикула -- агрегированная статистика по всем товарам
- Формирует системный промпт с контекстом:
  ```
  Ты -- AI-аналитик по отзывам Wildberries. У тебя есть полный доступ к базе отзывов.
  
  Текущие товары в базе:
  - Артикул 471329594: "Сумка большая эко замшевая шоппер", 617 отзывов, средний рейтинг 4.87
  - ...
  
  [Если запрошен конкретный артикул:]
  Отзывы по артикулу 471329594:
  1. Рейтинг 5/5. Плюсы: "Вместительная". Комментарий: "Отличная сумка!"
  2. ...
  ```
- Отправляет запрос в Lovable AI Gateway (streaming) с `google/gemini-3-flash-preview`
- Возвращает SSE-поток на фронтенд

### 2. Новый файл: `src/components/AiAssistant.tsx`

Компонент чата с ИИ:

- Поле ввода сообщения внизу (аналогичный стиль ChatWindow)
- Список сообщений с markdown-рендерингом (react-markdown не нужен -- используем простой текст с переносами)
- Streaming-отображение: токены появляются по мере получения
- Индикатор загрузки ("ИИ думает...")
- Заготовленные быстрые вопросы (chips) при пустом чате:
  - "Статистика по всем товарам"
  - "Основные жалобы покупателей"
  - "Какие товары лучше всего оценены?"

### 3. Новый файл: `src/hooks/useAiAssistant.ts`

Хук для управления состоянием чата:

- `messages` -- массив `{role, content}`
- `isLoading` -- флаг загрузки
- `sendMessage(text)` -- отправка с SSE-стримингом
- Логика парсинга SSE-потока (line-by-line, как в документации)

### 4. Изменение: `src/pages/Index.tsx`

Добавить рендеринг `<AiAssistant />` при `activeTab === "ai"`.

### 5. Изменение: `supabase/config.toml`

Добавить секцию для новой функции:
```
[functions.ai-assistant]
verify_jwt = false
```

## Детали реализации

### Контекст из БД

При каждом сообщении функция загружает:

1. **Всегда** -- сводку по всем товарам (артикул, название, кол-во отзывов, средний рейтинг, распределение по звёздам)
2. **При упоминании артикула** -- до 50 последних отзывов с полями text, pros, cons, rating, author_name
3. **При вопросе о проблемах/жалобах** -- отзывы с рейтингом 1-3 (до 30 штук)
4. **При вопросе о преимуществах** -- отзывы с рейтингом 4-5 и непустыми pros (до 30 штук)

### Модель

Используется Lovable AI с моделью `google/gemini-3-flash-preview` -- быстрая, хорошо подходит для аналитических задач. Ключ `LOVABLE_API_KEY` уже настроен автоматически.

### Streaming

SSE-стриминг по протоколу из документации Lovable AI: line-by-line парсинг, обработка `[DONE]`, обновление последнего assistant-сообщения по мере поступления токенов.

## Результат

- Новая вкладка "AI" с полнофункциональным чатом
- ИИ знает все товары, артикулы, отзывы, плюсы и минусы
- Streaming-ответы для быстрого отклика
- Быстрые вопросы для начала работы
