

# Расширение контекста AI аналитика: агрегированная статистика по датам

## Проблема

AI аналитик получает максимум 30 негативных отзывов (`.limit(30)`), поэтому не может анализировать временные паттерны по всей базе из 1000+ отзывов. Отправлять все отзывы целиком невозможно — они не поместятся в контекст.

## Решение

Добавить предварительно агрегированную статистику по дням недели и часам прямо в edge-функции, и передавать её в контекст AI. Это даст аналитику полную картину без необходимости видеть каждый отзыв.

## Что изменится

### Файл: `supabase/functions/ai-assistant/index.ts`

1. **Новая функция `getTimeStats`** — загружает ВСЕ отзывы пользователя (только `created_date` и `rating`), и считает:
   - Количество отзывов и средний рейтинг по каждому дню недели (Пн-Вс)
   - Количество отзывов и средний рейтинг по часам (0-23)
   - Отдельно для негативных (1-3) и позитивных (4-5)

2. **Добавить блок статистики в `contextParts`** — результат агрегации добавляется в системный промпт, например:
   ```
   Статистика по дням недели (все отзывы):
   Пн: 150 отзывов, ср. рейтинг 4.2, негативных: 20
   Вт: 180 отзывов, ср. рейтинг 3.8, негативных: 45
   ...

   Статистика по часам:
   08:00-08:59: 30 отзывов, негативных: 5
   ...
   ```

3. **Увеличить лимит сырых отзывов** с 30 до 50 для негативных/позитивных выборок (строки 306, 322).

4. **Обновить системный промпт** — добавить в список возможностей анализ по дням недели и времени суток.

### Технические детали

Агрегация происходит в TypeScript на стороне edge-функции (не в SQL), чтобы не создавать дополнительных database-функций:

```typescript
async function getTimeStats(supabase: any, userId: string) {
  const { data } = await supabase
    .from("reviews")
    .select("created_date, rating")
    .eq("user_id", userId);

  const days = ["Вс","Пн","Вт","Ср","Чт","Пт","Сб"];
  const byDay: Record<string, {total:number, neg:number, sumRating:number}> = {};
  const byHour: Record<number, {total:number, neg:number, sumRating:number}> = {};

  for (const r of data || []) {
    const d = new Date(r.created_date);
    const dayName = days[d.getUTCDay()];
    const hour = d.getUTCHours();
    // accumulate...
  }
  // format into readable text
}
```

Это добавит ~20 строк контекста вместо 1000+ сырых отзывов, но даст полную картину по временным паттернам.

