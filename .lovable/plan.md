
# Автоматическая архивация отзывов

## Идея

Два сценария работы с архивом:

1. **Первое подключение** -- при сохранении API-ключа автоматически загрузить все ранее отвеченные отзывы из Wildberries в архив (сейчас это делается кнопкой вручную)
2. **Еженедельная архивация** -- каждый понедельник в 10:00 автоматически перемещать отвеченные отзывы (статус `sent` и `auto`) в архив, чтобы основной список не засорялся

## Текущее состояние

- Кнопка "Загрузить архив" вызывает `fetch-archive` -- загружает уже отвеченные на WB отзывы и сохраняет их со статусом `archived`
- Отзывы со статусами `sent` и `auto` (отвеченные через систему) остаются в основном списке навсегда -- они никогда не переходят в архив
- Есть два cron-задания (каждые 5 минут): `sync-reviews` и `sync-chats`
- Кнопки "Загрузить архив" в интерфейсе можно убрать после автоматизации

## Что будет сделано

### 1. Автозагрузка архива при первом подключении

**Файл: `supabase/functions/validate-api-key/index.ts`**

После успешной валидации и сохранения API-ключа -- проверить, есть ли уже отзывы в базе. Если нет (первое подключение), автоматически вызвать `fetch-archive` для загрузки истории:

```text
Логика:
1. Ключ прошёл проверку и сохранён
2. Считаем количество отзывов в БД
3. Если reviews.count === 0 --> вызываем fetch-archive
4. Возвращаем результат с флагом archive_imported: true/false
```

### 2. Новая функция: archive-old-reviews

**Новый файл: `supabase/functions/archive-old-reviews/index.ts`**

Эта функция будет переводить отвеченные отзывы в архив:

```text
Логика:
1. Найти все отзывы со статусом 'sent' или 'auto',
   у которых updated_at старше 7 дней (чтобы свежие ответы
   были видны в основном списке хотя бы неделю)
2. Обновить их статус на 'archived'
3. Вернуть количество перемещённых отзывов
```

Порог в 7 дней -- чтобы только что отвеченные отзывы не исчезали из основного списка мгновенно. Свежие ответы (за последнюю неделю) останутся видимыми.

### 3. Cron-задание: еженедельная архивация

**SQL (через insert tool, не миграция):**

Создать новое cron-задание для вызова `archive-old-reviews` каждый понедельник в 10:00 (по UTC):

```text
Расписание: 0 10 * * 1 (каждый понедельник в 10:00 UTC)
Функция: archive-old-reviews
```

### 4. Регистрация функции

**Файл: `supabase/config.toml`**

Добавить секцию для новой функции:

```text
[functions.archive-old-reviews]
verify_jwt = false
```

### 5. Обновление интерфейса

**Файл: `src/components/ApiStatus.tsx`**

Убрать кнопку "Загрузить архив" -- теперь архив загружается автоматически при первом подключении и обновляется еженедельно.

**Файл: `src/pages/Index.tsx`**

Убрать проп `onFetchArchive` и связанную логику `useFetchArchive`.

**Файл: `src/hooks/useReviews.ts`**

Обновить `useValidateApiKey` -- добавить обработку ответа с `archive_imported`, показать уведомление если архив был загружен.

## Схема работы

```text
Первое подключение:
  Пользователь вводит API-ключ
    --> validate-api-key проверяет ключ
    --> Ключ валиден, сохраняется
    --> reviews.count === 0?
        Да --> вызов fetch-archive (загрузка истории)
        Нет --> пропуск (архив уже был загружен ранее)

Регулярная работа (каждые 5 мин):
  sync-reviews --> новые отзывы, авто-ответы

Еженедельно (Пн 10:00):
  archive-old-reviews --> отвеченные 7+ дней назад --> статус "archived"
```

## Файлы

| Файл | Изменение |
|------|-----------|
| `supabase/functions/validate-api-key/index.ts` | Автозагрузка архива при первом подключении |
| `supabase/functions/archive-old-reviews/index.ts` | Новая функция для переноса отвеченных отзывов в архив |
| `supabase/config.toml` | Регистрация новой функции |
| `src/components/ApiStatus.tsx` | Убрать кнопку "Загрузить архив" |
| `src/pages/Index.tsx` | Убрать логику ручной загрузки архива |
| `src/hooks/useReviews.ts` | Уведомление о загрузке архива при подключении |
| SQL (cron) | Новое задание: каждый понедельник 10:00 |
