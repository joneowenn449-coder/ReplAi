

# Настройка режима ответов по рейтингу (1-5 звёзд)

## Что будет сделано

Вместо одного общего переключателя "Авто-ответы" появится возможность настроить для каждого рейтинга (от 1 до 5 звёзд) свой режим:
- **Авто** -- ИИ генерирует ответ и сразу отправляет на WB
- **Ручной** -- ИИ генерирует черновик, отзыв попадает в "Ожидают" на согласование

Например, можно настроить автоматические ответы на 4-5 звёзд, а на 1-3 звезды -- ручной режим, чтобы проверять ответы перед отправкой.

## Где будут настройки

Переключатели по рейтингу будут размещены в **диалоге настроек** (SettingsDialog), поскольку это более детальная конфигурация. В статус-панели (ApiStatus) вместо одного переключателя будет краткая сводка текущих настроек, например: "Авто: 4-5 ★ | Ручной: 1-3 ★".

## Шаги реализации

### 1. Миграция базы данных

Добавить новый столбец `reply_modes` типа JSONB в таблицу `settings`:

```text
Формат: {"1": "manual", "2": "manual", "3": "manual", "4": "auto", "5": "auto"}
По умолчанию: все рейтинги в режиме "manual"
```

Столбец `auto_reply_enabled` останется для обратной совместимости, но перестанет использоваться в логике. Новая функция синхронизации будет опираться только на `reply_modes`.

### 2. Обновить backend-функцию `sync-reviews`

Текущая логика:
```text
if (autoReply && aiDraft) -> отправить на WB, статус "auto"
else -> статус "pending"
```

Новая логика:
```text
replyModes = settings.reply_modes || все "manual"
if (replyModes[rating] === "auto" && aiDraft) -> отправить на WB, статус "auto"
else -> статус "pending"
```

### 3. Обновить интерфейс настроек (SettingsDialog)

Добавить секцию "Режим ответов по рейтингу" с 5 переключателями:

```text
Режим ответов по рейтингу
  ★★★★★  [Авто / Ручной]
  ★★★★   [Авто / Ручной]
  ★★★    [Авто / Ручной]
  ★★     [Авто / Ручной]
  ★      [Авто / Ручной]
```

Каждая строка содержит рейтинг (звёзды) и переключатель (Switch). Подсказка: "Авто -- ответ отправляется сразу, Ручной -- попадает на согласование".

### 4. Обновить статус-панель (ApiStatus)

Убрать одиночный переключатель "Авто-ответы". Вместо него показать текстовую сводку текущего режима, например:
- "Авто: ★4-5 | Ручной: ★1-3"
- Или "Все ответы вручную" / "Все ответы автоматически"

### 5. Обновить типы и хуки (useReviews.ts)

- Добавить `reply_modes` в интерфейс `Settings`
- Обновить `useUpdateSettings` для сохранения `reply_modes`
- Удалить/обновить пропсы `autoReply` / `onAutoReplyChange` из ApiStatus

## Технические детали

**Файлы, которые будут изменены:**
- `supabase/migrations/` -- новая миграция для `reply_modes`
- `supabase/functions/sync-reviews/index.ts` -- логика per-rating auto/manual
- `src/components/SettingsDialog.tsx` -- переключатели по рейтингу
- `src/components/ApiStatus.tsx` -- сводка режимов вместо общего переключателя
- `src/hooks/useReviews.ts` -- обновление типа Settings
- `src/pages/Index.tsx` -- обновление пропсов ApiStatus

**Формат данных `reply_modes`:**
```text
JSONB: {"1": "manual", "2": "manual", "3": "manual", "4": "auto", "5": "auto"}
Значения: "auto" | "manual"
По умолчанию: все "manual" (безопасный режим)
```

