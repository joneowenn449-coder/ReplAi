

# Улучшение системного промпта: обработка отказов и возвратов

## Проблема

Покупатель Яна написала "Отдала предпочтение другой модели и другому цвету" -- это явный сигнал отказа от покупки. Но ИИ ответил "Благодарим Вас за выбор сумки LUNERA" -- прямое противоречие.

Причина: промпт не содержит правила для обработки ситуаций, когда покупатель НЕ выкупил товар.

## Решение

Двойной подход: обновить промпт в базе данных + добавить автоматическое определение "отказа" в коде edge-функций.

## Что будет сделано

### 1. Обновить системный промпт в базе данных

Добавить новое правило в промпт:

```
- ВАЖНО: Если в тексте отзыва есть признаки того, что покупатель НЕ выкупил товар 
  (слова: "отказ", "вернул(а)", "отдал(а) предпочтение другой модели", "не выкупил(а)", 
  "не подошл(о/а)", "возврат", "отправил(а) обратно", "другой цвет/размер"), 
  то НЕЛЬЗЯ благодарить за покупку/выбор товара. 
  Вместо этого: поблагодари за внимание к бренду, вырази сожаление, 
  что товар не подошёл, и пригласи вернуться за другой моделью/цветом.
```

### 2. Добавить автоматическое определение "отказа" в коде

В обеих edge-функциях (`generate-reply` и `sync-reviews`) добавить проверку текста отзыва на ключевые слова отказа/возврата. Если обнаружены -- добавить явное предупреждение в user-сообщение для ИИ:

```
[ВНИМАНИЕ: В тексте обнаружены признаки отказа от покупки. 
НЕ благодари за покупку или выбор товара.]
```

## Технические детали

### Изменяемые файлы

1. **`supabase/functions/generate-reply/index.ts`**
   - Добавить функцию `detectRefusal(text, pros, cons)` -- проверяет наличие ключевых слов отказа
   - В построении `userMessage` добавить предупреждение, если обнаружен отказ

2. **`supabase/functions/sync-reviews/index.ts`**
   - Аналогичная функция `detectRefusal` и передача флага в `generateAIReply`
   - Обновить сигнатуру `generateAIReply` для приёма параметра `isRefusal`

3. **SQL-миграция** -- обновить `ai_prompt_template` в таблице `settings` для вашего аккаунта, добавив правило об отказах

### Ключевые слова для определения отказа

Список фраз, которые будут проверяться в тексте, плюсах и минусах отзыва:
- "отказ", "вернул", "вернула", "возврат"
- "не выкупил", "не выкупила", "не забрал", "не забрала"
- "отдал предпочтение", "отдала предпочтение"
- "не подошёл", "не подошла", "не подошло"
- "отправил обратно", "отправила обратно"
- "выбрал другой", "выбрала другую", "выбрала другой"

### Пример изменения в user-сообщении

До:
```
Отзыв (4 из 5 звёзд) на товар "Сумка большая эко замшевая шоппер":
Комментарий: Отличная сумка. Отдала предпочтение другой модели...
```

После:
```
[ВНИМАНИЕ: Покупатель НЕ выкупил товар (обнаружены признаки отказа).
НЕ благодари за покупку или выбор товара. Поблагодари за внимание к бренду.]

Отзыв (4 из 5 звёзд) на товар "Сумка большая эко замшевая шоппер":
Комментарий: Отличная сумка. Отдала предпочтение другой модели...
```

### Ожидаемый результат для данного отзыва

Вместо: "Благодарим Вас за выбор сумки LUNERA"
Будет что-то вроде: "Здравствуйте, Яна! Спасибо за внимание к бренду LUNERA и подробный отзыв! Нам жаль, что эта модель не подошла..."

