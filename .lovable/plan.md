

# Автоматическая синхронизация каждые 5 минут

## Что будет сделано

Настроим автоматический вызов функции `sync-reviews` каждые 5 минут через планировщик задач в базе данных. Это полностью серверная задача -- приложение не нужно держать открытым, синхронизация будет работать в фоне.

## Безопасность со стороны WB

Wildberries допускает **3 запроса в секунду** (с пиком до 6). Один GET-запрос раз в 5 минут -- это менее 0.004 запроса в секунду, так что запас огромный. Даже если при auto-reply отправляется несколько ответов подряд, между ними стоит задержка 350мс, что укладывается в лимит.

## Технические шаги

1. **Включить расширения `pg_cron` и `pg_net`** -- это встроенные расширения базы данных, которые позволяют запускать задачи по расписанию и делать HTTP-вызовы.

2. **Создать cron-задачу** -- SQL-запрос, который каждые 5 минут будет отправлять HTTP POST запрос к функции `sync-reviews`:

```text
Расписание: */5 * * * * (каждые 5 минут)
Действие: HTTP POST -> sync-reviews edge function
Заголовки: Authorization с ключом проекта
```

3. **Миграция базы данных** -- будет создана одна SQL-миграция, которая:
   - Включает расширение `pg_cron` (если еще не включено)
   - Включает расширение `pg_net` (если еще не включено)
   - Создает задачу `sync-wb-reviews` с расписанием `*/5 * * * *`
   - Задача вызывает функцию `sync-reviews` через HTTP POST с правильными заголовками авторизации

Никаких изменений в коде фронтенда или edge-функций не требуется -- они уже готовы.
