

# Загрузка архивных отзывов из WB

## Что будет сделано

Добавится кнопка "Загрузить архив" для одноразовой выгрузки всех ранее отвеченных отзывов из WB API. Они сохранятся в базу со статусом `archived` и будут доступны на отдельной вкладке "Архив".

## Нагрузка на ресурсы

Эта функция **не будет создавать постоянную нагрузку**:

- Архив загружается **один раз** по нажатию кнопки (не автоматически)
- WB API отдает до 50 отзывов за запрос, с паузой 350мс между запросами (соблюдение лимита 3 req/sec)
- Например, 500 отзывов = ~10 запросов = ~4 секунды
- Данные хранятся в той же таблице `reviews`, просто с другим статусом
- При повторном нажатии дубли не создаются (проверка по `wb_id`)

## Шаги реализации

### 1. Новая backend-функция `fetch-archive`

Создать edge-функцию, которая:
- Читает WB API ключ из настроек (как в `sync-reviews`)
- Запрашивает `GET /api/v1/feedbacks?isAnswered=true&take=50&skip=0`, затем `skip=50`, `skip=100` и т.д. пока есть данные
- Для каждого отзыва проверяет, нет ли уже записи с таким `wb_id`
- Сохраняет новые записи в таблицу `reviews` со статусом `archived` и заполняет `sent_answer` из ответа WB API
- Возвращает количество загруженных отзывов

### 2. Зарегистрировать функцию

Добавить в `supabase/config.toml`:
```text
[functions.fetch-archive]
verify_jwt = false
```

### 3. Обновить фильтры (FilterTabs)

Добавить вкладку "Архив" в список фильтров с подсчётом количества:
```text
Все | Новые | Ожидают | Автоответ | Отправлено | Архив
```

Счётчик "Все" будет показывать только активные отзывы (без архивных), чтобы не путать.

### 4. Обновить хуки (useReviews)

- Расширить тип статуса: `"new" | "pending" | "auto" | "sent" | "archived"`
- Добавить хук `useFetchArchive` для вызова edge-функции
- Обновить `useReviews` -- при фильтре "all" показывать все кроме архивных, при фильтре "archived" -- только архивные

### 5. Обновить главную страницу (Index.tsx)

- Добавить подсчет `archived` в stats
- Передать счётчик `archived` в FilterTabs
- Логика фильтрации: `all` = всё кроме архивных, `archived` = только архивные

### 6. Обновить ReviewCard

- Добавить стиль для бейджа "Архив"
- Для архивных отзывов показывать сохранённый ответ (поле `sent_answer`), но без кнопок действий (отправить/перегенерировать)

### 7. Кнопка загрузки архива

Добавить кнопку "Загрузить архив" в компонент `ApiStatus` (рядом с "Синхронизировать"). Кнопка будет доступна только при подключённом API-ключе. Во время загрузки показывается спиннер и прогресс.

## Технические детали

**Файлы, которые будут созданы:**
- `supabase/functions/fetch-archive/index.ts` -- edge-функция загрузки архива

**Файлы, которые будут изменены:**
- `supabase/config.toml` -- регистрация новой функции
- `src/hooks/useReviews.ts` -- новый хук + обновление типов
- `src/components/FilterTabs.tsx` -- вкладка "Архив"
- `src/pages/Index.tsx` -- логика фильтрации и подсчёты
- `src/components/ReviewCard.tsx` -- стиль архивного бейджа
- `src/components/ApiStatus.tsx` -- кнопка загрузки архива

**Пагинация WB API:**
- Запрос `isAnswered=true&take=50&skip=N`
- Цикл продолжается, пока API возвращает непустой массив
- Между запросами пауза 350мс для соблюдения лимита

**Защита от дублей:**
- Перед вставкой каждого отзыва проверяется наличие записи с таким `wb_id`
- Если отзыв уже есть (например, был отправлен через систему) -- пропускается

