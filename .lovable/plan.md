
# Исправление рекомендаций товаров

## Обнаруженные проблемы

1. **Рекомендации не сохраняются** -- при добавлении рекомендации в хуке `useAddRecommendation` не передаётся `user_id`. RLS-политика на INSERT требует `user_id = auth.uid()`, поэтому вставка отклоняется (или user_id = null, и запись не видна через SELECT).

2. **ИИ не использует рекомендации** -- следствие первой проблемы: таблица `product_recommendations` пуста, поэтому в промпт генерации ответа рекомендации не попадают. Сам код в `generate-reply` корректный -- он подтягивает рекомендации и формирует инструкцию для ИИ. Но данных нет.

3. **Нет обзора рекомендаций** -- в интерфейсе нужно сначала выбрать артикул, чтобы увидеть его рекомендации. Нет сводной таблицы "какой артикул к каким привязан".

## Что будет исправлено

### 1. Исправить сохранение рекомендаций

**Файл**: `src/hooks/useRecommendations.ts`

В функции `useAddRecommendation` добавить `user_id` при вставке. Для этого получить текущего пользователя через `supabase.auth.getUser()` перед INSERT:

```typescript
const { data: { user } } = await supabase.auth.getUser();
if (!user) throw new Error("Не авторизован");

const { error } = await supabase
  .from("product_recommendations")
  .insert({
    source_article: sourceArticle,
    target_article: targetArticle,
    target_name: targetName,
    user_id: user.id,  // <-- добавить
  });
```

### 2. Добавить сводку рекомендаций в интерфейс

**Файл**: `src/components/RecommendationsSection.tsx`

Добавить компактную сводку всех настроенных рекомендаций -- маленькую таблицу/список, показывающую:
- Артикул-источник
- Количество привязанных рекомендаций
- Кликабельность для быстрого перехода к редактированию

Для этого добавить новый запрос `useAllRecommendations` в хук, который загружает все рекомендации пользователя и группирует по source_article.

### 3. Проверить работу ИИ с рекомендациями

Код в `generate-reply` уже корректно:
- Запрашивает рекомендации по `source_article` и `user_id`
- Формирует инструкцию для ИИ с артикулами
- Добавляет инструкцию в промпт

После исправления сохранения данные появятся в таблице, и ИИ начнёт автоматически добавлять рекомендации в ответы.

## Технические детали

### Изменяемые файлы:
- `src/hooks/useRecommendations.ts` -- добавить `user_id` в INSERT, добавить хук `useAllRecommendationsSummary`
- `src/components/RecommendationsSection.tsx` -- добавить сводку всех рекомендаций над селектором

### Новые хуки:
- `useAllRecommendationsSummary` -- загружает все рекомендации текущего пользователя, группирует по `source_article`, возвращает массив `{ article, name, count }`
