

# Сохранение чатов AI аналитика с боковой панелью

## Что будет сделано

Слева от чата появится панель с историей разговоров. Каждый чат можно будет закрепить, переименовать или удалить через меню (три точки). Все сообщения сохраняются в базу и доступны после перезагрузки.

## Визуальная структура

```text
+---------------------------+----------------------------------------------+
|  AI Аналитик              |  Шапка чата (название текущего разговора)     |
+---------------------------+----------------------------------------------+
|  [+ Новый чат]            |                                              |
|                           |                                              |
|  --- Закрепленные ---     |   Сообщения текущего чата                    |
|  Анализ за январь  (...)  |   (markdown, пузыри)                         |
|                           |                                              |
|  --- Сегодня ---          |                                              |
|  Жалобы покупателей (...)  |                                              |
|  Статистика товаров (...)  |                                              |
|                           |                                              |
|  --- Вчера ---            |                                              |
|  Рейтинг по дням   (...)  |                                              |
|                           +----------------------------------------------+
|                           |  [Поле ввода]                          [->]  |
+---------------------------+----------------------------------------------+
```

Меню трех точек `(...)` содержит: Закрепить / Открепить, Переименовать, Удалить.

## Этапы реализации

### 1. Создание таблиц в базе данных

Две новые таблицы:

**`ai_conversations`** -- список чатов пользователя:
- `id` (uuid, PK)
- `user_id` (uuid, NOT NULL)
- `title` (text, default "Новый чат")
- `is_pinned` (boolean, default false)
- `created_at`, `updated_at` (timestamptz)

**`ai_messages`** -- сообщения внутри чатов:
- `id` (uuid, PK)
- `conversation_id` (uuid, FK -> ai_conversations)
- `role` (text, "user" или "assistant")
- `content` (text)
- `created_at` (timestamptz)

RLS-политики: пользователь видит и управляет только своими чатами. Каскадное удаление сообщений при удалении чата.

### 2. Хук `useAiConversations`

Новый файл `src/hooks/useAiConversations.ts`:
- `useConversationList()` -- список всех чатов пользователя (сортировка: pinned сверху, потом по дате)
- `useCreateConversation()` -- создание нового чата
- `useRenameConversation()` -- переименование
- `useTogglePin()` -- закрепить/открепить
- `useDeleteConversation()` -- удаление чата (сообщения удалятся каскадно)

### 3. Обновление `useAiAssistant`

Файл `src/hooks/useAiAssistant.ts`:
- Принимает `conversationId` как параметр
- При монтировании загружает сообщения из `ai_messages` для текущего чата
- После каждого ответа AI сохраняет пару user/assistant сообщений в `ai_messages`
- Автогенерация названия: после первого ответа берет первые ~40 символов вопроса пользователя как title

### 4. Компонент боковой панели `AiChatSidebar`

Новый файл `src/components/AiChatSidebar.tsx`:
- Кнопка «+ Новый чат» сверху
- Группировка по секциям: Закрепленные, Сегодня, Вчера, Ранее
- Каждый элемент списка: название чата, троеточие справа
- Активный чат подсвечивается
- Меню из трех точек (DropdownMenu): Закрепить/Открепить, Переименовать, Удалить
- Переименование: inline-редактирование прямо в списке

### 5. Обновление `AiAssistant.tsx`

- Обернуть в flex-контейнер: sidebar (w-64) + основной чат
- Передавать `selectedConversationId` в обновленный хук
- При выборе чата из сайдбара -- загружать его сообщения
- При «Новый чат» -- создавать запись в базе и переключаться на нее
- Кнопка «Очистить» в хедере заменяется на «Новый чат» (логика переносится в sidebar)

## Технические детали

- Используются существующие компоненты: `DropdownMenu`, `ScrollArea`, `Button`, `Input`
- Группировка по датам через `date-fns` (уже установлен)
- Realtime не нужен -- данные обновляются через `invalidateQueries` после мутаций
- Стилистика сайдбара в Apple-стиле: тонкий `border-r`, мягкие hover-эффекты, `text-[13px]` для элементов списка
