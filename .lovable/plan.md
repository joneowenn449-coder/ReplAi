

# Исправление: автоответ не отправлен и фото не загружаются

## Проблема 1: Автоответ не отправлен

### Диагностика
- Настройки в базе: `reply_modes["5"] = "auto"` -- режим для 5 звёзд действительно "авто"
- Отзыв Гузяль: `status = "pending"`, `ai_draft` сгенерирован успешно
- В логах `sync-reviews` нет ошибок автоотправки
- Время синхронизации: `06:20` (первый раз) -- отзыв был вставлен в БД

### Причина
Дизайн-проблема: отзыв попал в базу со статусом "pending", и на повторных синхронизациях пропускается (проверка `if (existing) continue`). Скорее всего, отзыв был впервые загружен, когда режим для 5 звёзд ещё стоял "manual", либо автоотправка завершилась ошибкой, которую не удалось увидеть в логах.

### Решение
Добавить в `sync-reviews` логику повторной отправки: после обработки новых отзывов, найти все существующие отзывы со статусом `pending`, у которых есть `ai_draft` и для их рейтинга включён режим "auto" -- и отправить их.

**Файл:** `supabase/functions/sync-reviews/index.ts`
- После цикла новых отзывов: запросить `reviews` с `status = "pending"` и непустым `ai_draft`
- Для каждого проверить `replyModes[rating]` -- если "auto", попробовать отправить
- Добавить подробное логирование попыток автоотправки (какой режим, какой рейтинг)

---

## Проблема 2: Фото не загружаются

### Диагностика
Данные `photo_links` в базе хранятся как массив объектов:
```text
[
  { "fullSize": "https://feedback11.wbbasket.ru/.../fs.jpg", "miniSize": "https://...ms.jpg" },
  ...
]
```

Но в `ReviewCard.tsx` свойство `images` типизировано как `string[]` и используется напрямую как `src={img}`. Поскольку `img` -- это объект, браузер пытается загрузить `[object Object]` вместо URL.

### Решение
Исправить передачу фото в `Index.tsx`: при передаче `images` в `ReviewCard` извлекать URL из объектов.

**Файл:** `src/pages/Index.tsx`
- Заменить `images={review.photo_links}` на маппинг, который извлекает `miniSize` (для превью) или `fullSize` из каждого объекта
- Обработать случаи, когда `photo_links` содержит просто строки (обратная совместимость)

```typescript
images={
  (review.photo_links || []).map((link: any) =>
    typeof link === "string" ? link : (link?.miniSize || link?.fullSize || "")
  ).filter(Boolean)
}
```

---

## Затрагиваемые файлы

| Файл | Изменение |
|------|-----------|
| `supabase/functions/sync-reviews/index.ts` | Добавить повторную отправку pending-отзывов с auto-режимом; добавить подробное логирование |
| `src/pages/Index.tsx` | Исправить передачу photo_links -- извлекать URL из объектов |

## Ожидаемый результат
- Отзыв Гузяль будет автоматически отправлен при следующей синхронизации (или вручную)
- Фотографии покупателей будут корректно отображаться в карточках отзывов
- Все будущие отзывы с pending-статусом и auto-режимом будут автоматически досылаться
