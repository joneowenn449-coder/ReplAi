
# Улучшение обработки пустых отзывов

## Проблема

Сейчас пустые отзывы обрабатываются некорректно:
- Для 4-5 звёзд используется минимальный промпт без системного промпта (без стиля бренда, emoji, тона) -- отсюда безликие "О., благодарим..."
- Для 1-3 звёзд нет специальной логики -- отзыв без текста попадает в общий промпт и получает невнятный ответ
- Название бренда и имя покупателя не всегда передаются для пустых отзывов

## Решение

Убрать отдельную ветку для пустых отзывов и вместо этого направлять ВСЕ отзывы через основной промпт, добавляя специальную инструкцию в зависимости от рейтинга.

## Что изменится

### Логика для пустых отзывов

- **4-5 звёзд без текста**: краткая благодарность за отзыв и оценку (1-2 предложения), с сохранением стиля бренда
- **1-3 звезды без текста**: выразить сожаление, что что-то не понравилось, и предложить написать в чат с продавцом для решения вопроса (1-2 предложения)

### Ключевое изменение

Вместо того чтобы обходить системный промпт для пустых отзывов, мы добавим специальную инструкцию в user-сообщение и пропустим через основной пайплайн. Это гарантирует, что:
- Стиль бренда (emoji, приветствия, тон) сохраняется
- Название бренда подставляется
- Имя покупателя используется
- Ответ остаётся коротким благодаря явной инструкции

### Пример добавляемых инструкций

Для 4-5 звёзд:
```
[Это пустой отзыв без текста. Покупатель поставил только оценку.
Напиши КОРОТКУЮ благодарность за отзыв и высокую оценку. Максимум 1-2 предложения.
Не задавай вопросов. Не фантазируй о товаре.]
```

Для 1-3 звёзд:
```
[Это пустой отзыв без текста. Покупатель поставил низкую оценку без пояснения.
Вырази сожаление, что опыт не оправдал ожиданий.
Предложи написать в чат с продавцом, чтобы разобраться в ситуации и помочь.
Максимум 1-2 предложения. Не задавай лишних вопросов.]
```

## Технические детали

### Изменяемые файлы

1. **`supabase/functions/sync-reviews/index.ts`** (функция `generateAIReply`)
   - Убрать отдельную ветку `if (isEmpty && rating >= 4)` (строки 68-96)
   - Вместо этого: если `isEmpty`, добавить соответствующую инструкцию в user-сообщение перед отправкой через основной пайплайн
   - Для 4-5 звёзд: инструкция на краткую благодарность
   - Для 1-3 звёзд: инструкция на сожаление + приглашение в чат
   - Установить `max_tokens: 300` для пустых отзывов (вместо 1000) для экономии

2. **`supabase/functions/generate-reply/index.ts`**
   - Убрать отдельную ветку `if (isEmptyReview && isHighRating)` (строки 104-148)
   - Аналогично: добавить специальную инструкцию в user-сообщение и пропустить через основной пайплайн
   - Для 4-5 звёзд: инструкция на краткую благодарность
   - Для 1-3 звёзд: инструкция на сожаление + приглашение в чат
   - Ограничить `max_tokens: 300` для пустых отзывов

### Структура изменений в коде

```text
generateAIReply (sync-reviews):
  БЫЛО:
    if (isEmpty && rating >= 4) -> отдельный короткий промпт БЕЗ системного
    else -> основной пайплайн
  
  СТАНЕТ:
    if (isEmpty) -> добавить emptyInstruction в userMessage
    -> ВСЁ через основной пайплайн с системным промптом
    -> max_tokens = isEmpty ? 300 : 1000

generate-reply:
  БЫЛО:
    if (isEmptyReview && isHighRating) -> отдельный короткий промпт БЕЗ системного
    else -> основной пайплайн

  СТАНЕТ:
    if (isEmptyReview) -> добавить emptyInstruction в userMessage
    -> ВСЁ через основной пайплайн с системным промптом
    -> max_tokens = isEmptyReview ? 300 : 1000
```

### Что это даёт

- Все отзывы без исключения получают ответ
- Стиль бренда сохраняется даже в коротких ответах на пустые отзывы
- Для низких оценок без текста -- корректный призыв в чат с продавцом
- Бренд и имя покупателя всегда учитываются
