

# Мультикабинет Wildberries: поддержка нескольких аккаунтов WB

## Текущая архитектура

Сейчас: 1 пользователь = 1 строка в таблице `settings` = 1 API-ключ WB. Отзывы и чаты привязаны к `user_id`. Это не позволяет работать с несколькими кабинетами WB одновременно.

## Новая архитектура

Вводим сущность **"Кабинет"** (`wb_cabinets`). Каждый кабинет содержит свой API-ключ, бренд, промпт, режимы ответов. Пользователь переключается между кабинетами, и все данные (отзывы, чаты) фильтруются по активному кабинету.

## Что будет сделано

### 1. Новая таблица `wb_cabinets`

Поля:
- `id` (UUID, PK)
- `user_id` (UUID, владелец)
- `name` (text) -- пользовательское название, например "Магазин Одежда", "Магазин Косметика"
- `wb_api_key` (text)
- `brand_name` (text)
- `ai_prompt_template` (text)
- `reply_modes` (jsonb)
- `last_sync_at` (timestamp)
- `is_active` (boolean, default false) -- только один кабинет активен у пользователя
- `created_at`, `updated_at`

RLS: пользователь видит/редактирует только свои кабинеты.

### 2. Колонка `cabinet_id` в таблицах `reviews` и `chats`

Добавляем `cabinet_id UUID` в таблицы `reviews`, `chats`, `chat_messages`, чтобы отзывы и чаты были привязаны к конкретному кабинету, а не просто к пользователю.

### 3. Миграция данных

Для существующих пользователей:
- Для каждой строки в `settings` создается кабинет с `is_active = true`
- Все существующие отзывы и чаты получают `cabinet_id` этого кабинета
- Таблица `settings` продолжает хранить общие настройки (или может быть упрощена)

### 4. Переключатель кабинетов в Header

В шапке рядом с логотипом появится выпадающий список (Select/Dropdown) с названиями кабинетов:
- Показывает активный кабинет
- Позволяет переключаться
- Кнопка "Добавить кабинет" внизу списка

### 5. Управление кабинетами в Настройках

В диалоге настроек:
- Список кабинетов с возможностью переименовать/удалить
- API-ключ, бренд, промпт, режимы ответов -- всё привязано к конкретному кабинету
- Добавление нового кабинета

### 6. Обновление Edge Functions

Функции `sync-reviews`, `sync-chats`, `generate-reply`, `send-reply` будут работать с `wb_cabinets` вместо `settings` для получения API-ключа. Фоновая синхронизация (pg_cron) будет итерировать по всем кабинетам с заполненным API-ключом.

### 7. Обновление фронтенда

- Хуки (`useReviews`, `useChats`, `useSettings`) фильтруют по `cabinet_id` активного кабинета
- Новый хук `useCabinets` для управления кабинетами
- Контекст `ActiveCabinetContext` для хранения текущего активного кабинета

## Технические детали

### Структура данных

```text
wb_cabinets
+------------+-------------------+
| id (UUID)  | user_id (UUID)    |
| name       | wb_api_key        |
| brand_name | ai_prompt_template|
| reply_modes| last_sync_at      |
| is_active  | created_at        |
+------------+-------------------+

reviews (добавляется)
+------------------+
| cabinet_id (UUID)|
+------------------+

chats (добавляется)
+------------------+
| cabinet_id (UUID)|
+------------------+
```

### Обеспечение "только один активный"

Триггер в базе данных: при установке `is_active = true` для кабинета автоматически сбрасывает `is_active = false` у всех остальных кабинетов того же пользователя.

### Порядок реализации

1. Миграция БД: таблица `wb_cabinets`, колонки `cabinet_id`, триггер, миграция данных
2. Контекст `ActiveCabinetContext` и хук `useCabinets`
3. Переключатель кабинетов в Header
4. Обновление SettingsDialog для работы с кабинетами
5. Обновление хуков `useReviews`, `useChats` для фильтрации по `cabinet_id`
6. Обновление Edge Functions (`sync-reviews`, `sync-chats`, `generate-reply`, `send-reply`)

### Обратная совместимость

- Существующие данные мигрируют автоматически
- Пользователи с одним кабинетом не заметят изменений (переключатель не показывается при одном кабинете)
- `cabinet_id` в reviews/chats nullable на переходный период

